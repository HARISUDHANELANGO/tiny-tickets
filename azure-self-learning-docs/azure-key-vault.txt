ğŸŸ¦ AZURE KEY VAULT â€” FULL JOURNEY SHEET (TinyTickets)
A complete documentation of what we did, why, how, issues faced, resolutions, and interview-ready insights.
1ï¸âƒ£ Goal of Key Vault Integration

Securely store all sensitive configurations:

SQL connection string

Service Bus connection string

Blob Storage connection string

â€¦and load them inside Program.cs using DefaultAzureCredential.

This eliminates secrets from:

âŒ appsettings.json
âŒ environment variables
âŒ repository / deployment logs

2ï¸âƒ£ Azure Setup Steps (Performed Successfully)
âœ” Step 1 â€” Create Key Vault

Name: tinytickets-vault

âœ” Step 2 â€” Assign yourself permissions

Using RBAC, not old Access Policies:

Required roles:

Role	Purpose
Key Vault Administrator	Full vault control
Key Vault Secrets Officer	CRUD Secrets
(Optional) Key Vault Reader	Safe read-only

âš ï¸ Important:
RBAC changes take 5â€“10 minutes before becoming active (we saw this warning).

âœ” Step 3 â€” Add Secrets

Inside Secrets â†’ Generate/Import:

Secret Name	Value
SqlConnectionString	Azure SQL connection
ServiceBusConnectionString	Service Bus namespace connection
StorageAccountConnectionString	Azure Storage account key

Naming rules followed:

No nested names like "ConnectionStrings:DefaultConnection"

Use flat names (ideal for Key Vault)

Matches the entries used in Program.cs

âœ” Step 4 â€” Access Key Vault from our API using DefaultAzureCredential

TinyTickets API is deployed to Azure App Service, so:

Locally â†’ it uses your AAD credentials

In Azure â†’ it uses the system-assigned managed identity

We enabled system-assigned identity in Portal âœ”.

3ï¸âƒ£ Code Integration Steps
âœ” Step 1 â€” Add Azure Key Vault NuGet
Install-Package Azure.Identity


(This package was already installed earlier.)

âœ” Step 2 â€” Add Key Vault loading BEFORE any Azure client is created

Correct placement in Program.cs:

var keyVaultUrl = builder.Configuration["KeyVaultUrl"];

if (!string.IsNullOrEmpty(keyVaultUrl))
{
    builder.Configuration.AddAzureKeyVault(
        new Uri(keyVaultUrl),
        new DefaultAzureCredential()
    );
}


Why this ordering matters:

SQL, Service Bus, Blob Storage clients must read updated config AFTER Key Vault is loaded.

You fixed this correctly in the final Program.cs.

âœ” Step 3 â€” All connection strings now come from vault
SQL:
var sql = builder.Configuration["SqlConnectionString"]
          ?? throw new Exception("SQL connection missing");

Service Bus:
var serviceBusConn = builder.Configuration["ServiceBusConnectionString"]
                     ?? throw new Exception("Service Bus connection missing");

Blob Storage:
var storage = builder.Configuration["StorageAccountConnectionString"]
              ?? throw new Exception("Storage account connection missing");


These match your Key Vault secret names perfectly.

4ï¸âƒ£ Issues Faced & Resolutions
âŒ 1. â€œThe operation is not allowed by RBACâ€

âœ” RESOLVED: You assigned yourself Admin + Secrets Officer.
Azure warned that stabilization takes 5 minutes.

âŒ 2. AddAzureKeyVault extension not found

Cause: Incorrect namespace + location inside Program.cs
âœ” RESOLVED:
Add extension AFTER builder created:

using Azure.Identity;
using Azure.Security.KeyVault.Secrets;


And ensure:

builder.Configuration.AddAzureKeyVault(...)

âŒ 3. Secrets not loading inside Blob / Service Bus constructors

Cause: Key Vault was being added after services were registered.

âœ” RESOLVED by moving:

builder.Configuration.AddAzureKeyVault(...)


before:

builder.Services.AddDbContext(...)
builder.Services.AddSingleton<ServiceBusClient>(...)
builder.Services.AddSingleton<SasTokenService>()

5ï¸âƒ£ Verification Checklist (Everything Completed)
Check	Status
Key Vault created	âœ”
RBAC roles assigned	âœ”
Secrets added correctly	âœ”
TinyTickets App uses Managed Identity	âœ”
Program.cs loads Key Vault early	âœ”
All Azure services read secrets from vault	âœ”
No secrets in appsettings.json	âœ”
Local debug uses Azure CLI credentials	âœ”
App Service has access to Key Vault	âœ”

You are 100% done with Key Vault integration.

6ï¸âƒ£ Key Vault Flow Cheat Sheet (Easy to Remember)
1. Create Key Vault  
2. Assign RBAC  
3. Add Secrets  
4. Enable Managed Identity  
5. Grant Vault access to identity  
6. Add AddAzureKeyVault() early in Program.cs  
7. Read secrets using builder.Configuration["SecretName"]  
8. Remove secrets from appsettings.json  


Simple rule:

â€œVault first â€” services next.â€
7ï¸âƒ£ Interview Perspective â€” What You Can Confidently Say
ğŸ”¥ Why use Key Vault instead of appsettings?

Centralized secure secret management

Rotatable keys

Zero exposure in CI/CD logs

Managed identity â†’ no credentials in code

App can auto-refresh secrets without redeploy

ğŸ”¥ Describe secret loading pipeline

Azure App Service â†’ Managed identity â†’ Key Vault â†’ IConfiguration â†’ DI Services

ğŸ”¥ How do you handle local debugging?

DefaultAzureCredential auto-selects:

Environment Variables

Azure CLI

VS Credential

Managed Identity (in Azure)

So no changes are required for local debug.

ğŸ”¥ What happens if Key Vault is down?

App startup throws an exception â†’ Safe failure
Better than booting with invalid secrets.

ğŸ”¥ Why use flat secret names?

Because nested secret names like "ConnectionStrings:DefaultConnection"
do not map well into Key Vault.

8ï¸âƒ£ Key Vault README (Final Copy-Paste Version)

Below is your clean README.md for Key Vault only:

ğŸ” Azure Key Vault Integration â€” TinyTickets API
Purpose

Securely manage all connection strings for:

SQL Database

Service Bus

Blob Storage

âœ” Steps Completed
1. Created Key Vault:

tintytickets-vault

2. Added RBAC roles:

Key Vault Administrator

Key Vault Secrets Officer

3. Added Secrets
Secret Name	Purpose
SqlConnectionString	Azure SQL
ServiceBusConnectionString	Azure Service Bus
StorageAccountConnectionString	Storage account
4. Enabled Managed Identity for App Service
5. Granted Vault access to the identity
âœ” Program.cs Integration
var keyVaultUrl = builder.Configuration["KeyVaultUrl"];

if (!string.IsNullOrEmpty(keyVaultUrl))
{
    builder.Configuration.AddAzureKeyVault(
        new Uri(keyVaultUrl),
        new DefaultAzureCredential()
    );
}

Reading from Key Vault:
builder.Configuration["SqlConnectionString"]
builder.Configuration["ServiceBusConnectionString"]
builder.Configuration["StorageAccountConnectionString"]

âœ” Learnings

Secrets must be flat names

RBAC roles take time to propagate

AddAzureKeyVault must run before any service registration

DefaultAzureCredential simplifies local + cloud authentication

âœ” Troubleshooting
âŒ â€œOperation not allowed by RBACâ€

â†’ Wait 5 minutes / Assign Secrets Officer

âŒ Extension method AddAzureKeyVault missing

â†’ Add namespace using Azure.Identity;

âŒ Secrets not loading in DI

â†’ Ensure Key Vault is configured before services

âœ” Interview Summary

Key Vault centralizes secrets

Eliminates secrets from code

Uses Managed Identity for credential-less access

A must-have in enterprise applications