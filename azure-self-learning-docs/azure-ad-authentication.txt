ğŸŸ¦ TinyTickets â€“ Azure AD Authentication (End-to-End Guide)

This document explains the complete, production-ready Azure Active Directory (AAD) authentication setup for:

TinyTickets-UI (Angular SPA)

TinyTickets-API-Pro (.NET 8 Web API)

Azure App Service

Azure Key Vault

This guide captures every step, configuration, and fix from the authentication debugging journey.

ğŸ“Œ 1. Architecture Overview
Layer	Tech	Purpose
Frontend	Angular + MSAL Browser	Authenticates user, obtains access token
Backend	.NET 8 API	Validates JWT from Azure AD
Identity Provider	Azure AD App Registrations	Issues tokens
Secrets	Azure Key Vault	Stores TenantId, ClientId, Audience, Instance

Authentication flow:

User â†’ MSAL Login â†’ UI retrieves access token
  â†’ Angular interceptor attaches token to API calls
     â†’ API validates issuer + audience + scope
         â†’ Authorized â†’ Returns Data

ğŸ“Œ 2. Azure AD Configuration

Azure AD requires two App Registrations:

ğŸŸ¦ 2.1 API App Registration â€” TinyTickets-API-Pro
Purpose

Expose secure APIs and validate JWT tokens.

Steps
âœ” A. Create app registration

Name: TinyTickets-API-Pro
Supported account types: My organization only

âœ” B. Set the Application ID URI

Go to:
Expose an API â†’ Application ID URI

Use:

api://<API_CLIENT_ID>


Example:

api://9768865e-83af-4a37-8785-b3a547a4e220

âœ” C. Create API Scope

Navigate:
Expose an API â†’ Add Scope

Field	Value
Scope name	access_as_user
Who can consent	Admins + Users
Description	Access TinyTickets API as user

The UI must request this scope.
The API must validate this scope.

ğŸŸ¦ 2.2 UI App Registration â€” TinyTickets-UI
Purpose

Allows Angular SPA to authenticate and request tokens.

Steps
âœ” A. Create App Registration

Name: TinyTickets-UI

âœ” B. Configure Redirect URIs

Go to:
Authentication â†’ Add platform â†’ SPA

Add:

https://salmon-rock-08a479500.3.azurestaticapps.net
http://localhost:4200

âœ” C. Assign Permissions

Go to:
API Permissions â†’ Add Permission â†’ My APIs

Choose:

TinyTickets-API-Pro â†’ Delegated â†’ access_as_user


ğŸ‘‰ In personal Microsoft accounts, Admin Consent is NOT required, so UI works without it.

ğŸ“Œ 3. Key Vault Secrets

Your Azure Key Vault must store:

Secret Name	Value
AzureAd--TenantId	0784cbd8-29cf-49ad-ae0e-4ebd47bf32d1
AzureAd--ClientId	<UI_CLIENT_ID>
AzureAd--Audience	api://<API_CLIENT_ID>
AzureAd--Instance	https://login.microsoftonline.com/

These are injected into your .NET Web App using:

@Microsoft.KeyVault(SecretUri=<your_secret_uri>)

ğŸ“Œ 4. Angular Setup (MSAL)
msal.config.ts
export const msalConfig = {
  auth: {
    clientId: '<UI_CLIENT_ID>',
    authority: 'https://login.microsoftonline.com/<TENANT_ID>',
    redirectUri: 'https://salmon-rock-08a479500.3.azurestaticapps.net',
  }
};

export const protectedResources = {
  tinyTicketsApi: {
    endpoint: 'https://tinytickets-api.azurewebsites.net/',
    scopes: ['api://9768865e-83af-4a37-8785-b3a547a4e220/access_as_user']
  }
};

ğŸ“Œ 5. Angular HTTP Interceptor (Final Working Version)
export const msalInterceptor: HttpInterceptorFn = (req, next) => {
  const auth = inject(AuthService);

  return from(auth.getToken()).pipe(
    switchMap((res) => {
      if (res?.accessToken) {
        req = req.clone({
          setHeaders: {
            Authorization: `Bearer ${res.accessToken}`,
          },
        });
      }
      return next(req);
    })
  );
};

ğŸ“Œ 6. .NET 8 API Authentication
Program.cs (Final Production Version)
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = $"https://login.microsoftonline.com/{tenantId}/v2.0";

        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidIssuers = new[]
            {
                $"https://sts.windows.net/{tenantId}/",
                $"https://login.microsoftonline.com/{tenantId}/v2.0"
            },

            ValidateAudience = true,
            ValidAudience = audience
        };
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("ApiScope", policy =>
    {
        policy.RequireAuthenticatedUser();
        policy.RequireClaim("scp", "access_as_user");
    });
});

Apply policy to secure endpoints
app.MapGet("/tickets", ...)
   .RequireAuthorization("ApiScope");

app.MapPost("/tickets", ...)
   .RequireAuthorization("ApiScope");

ğŸ“Œ 7. Azure CORS Configuration

Azure Portal â†’ App Service â†’ CORS

Add allowed origins:

https://salmon-rock-08a479500.3.azurestaticapps.net


Enable:

âœ” Access-Control-Allow-Credentials

ğŸ“Œ 8. Expected Token Structure

Your JWT must contain:

{
  "aud": "api://<API_CLIENT_ID>",
  "scp": "access_as_user",
  "tid": "<TENANT_ID>",
  "appid": "<UI_CLIENT_ID>"
}


If these claims are present, your API will authorize the request.

ğŸ“Œ 9. Troubleshooting Summary
Issue	Root Cause	Fix
401 Unauthorized	Wrong audience or issuer	Fixed Key Vault + Program.cs
403 Forbidden	Scope mismatched	Recreated access_as_user correctly
Token shows ver: 1.0	Normal for personal accounts	Added sts.windows.net issuer
Admin Consent disabled	Normal for MSA	No action required
UI gets token but API rejects	Wrong MSAL config	Fixed scopes + authority

ğŸ” Final Authentication Flow (Simple & Clear)

1ï¸âƒ£ User logs in through the Angular UI using Azure ADâ€™s MSAL login screen.
2ï¸âƒ£ MSAL acquires an access token (a JWT) containing:

issuer (iss) â†’ who issued it

audience (aud) â†’ which API it is meant for

scopes (scp) â†’ what permissions the user has

3ï¸âƒ£ Angular automatically attaches this token to every API request using the MSAL Interceptor:

Authorization: Bearer <access_token>


4ï¸âƒ£ API receives the request and validates the token by checking:

âœ” issuer matches your Azure AD tenant

âœ” audience matches your API's Application ID URI

âœ” scope contains access_as_user

5ï¸âƒ£ If all checks pass â†’ API returns the response normally.
If any check fails â†’ API returns 401/403 (unauthorized/forbidden).